{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "ws-protocol-schema",
  "title": "WebSocket Protocol Schema",
  "type": "object",
  "properties": {},
  "definitions": {
    "Envelope": {
      "type": "object",
      "required": [
        "v",
        "type",
        "topic",
        "ts",
        "data"
      ],
      "additionalProperties": false,
      "properties": {
        "v": {
          "type": "integer",
          "const": 1,
          "description": "Protocol version"
        },
        "type": {
          "type": "string",
          "description": "Message type identifier"
        },
        "topic": {
          "type": "string",
          "description": "Topic routing string (e.g., 'agent:123', 'thread:456')"
        },
        "req_id": {
          "type": "string",
          "description": "Optional request correlation ID"
        },
        "ts": {
          "type": "integer",
          "description": "Timestamp in milliseconds since epoch"
        },
        "data": {
          "type": "object",
          "description": "Message payload - structure depends on type"
        }
      }
    },
    "AgentRef": {
      "type": "object",
      "required": [
        "id"
      ],
      "properties": {
        "id": {
          "type": "integer",
          "minimum": 1
        }
      }
    },
    "ThreadRef": {
      "type": "object",
      "required": [
        "thread_id"
      ],
      "properties": {
        "thread_id": {
          "type": "integer",
          "minimum": 1
        }
      }
    },
    "UserRef": {
      "type": "object",
      "required": [
        "id"
      ],
      "properties": {
        "id": {
          "type": "integer",
          "minimum": 1
        }
      }
    },
    "ExecutionRef": {
      "type": "object",
      "required": [
        "execution_id"
      ],
      "properties": {
        "execution_id": {
          "type": "integer",
          "minimum": 1
        }
      }
    },
    "PingData": {
      "type": "object",
      "properties": {
        "timestamp": {
          "type": "integer",
          "minimum": 0
        }
      }
    },
    "PongData": {
      "type": "object",
      "properties": {
        "timestamp": {
          "type": "integer",
          "minimum": 0
        }
      }
    },
    "ErrorData": {
      "type": "object",
      "required": [
        "error"
      ],
      "properties": {
        "error": {
          "type": "string",
          "minLength": 1
        },
        "details": {
          "type": "object"
        }
      }
    },
    "SubscribeData": {
      "type": "object",
      "required": [
        "topics"
      ],
      "properties": {
        "topics": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "minItems": 1
        },
        "message_id": {
          "type": "string"
        }
      }
    },
    "SubscribeAckData": {
      "type": "object",
      "required": [
        "message_id",
        "topics"
      ],
      "properties": {
        "message_id": {
          "type": "string",
          "minLength": 1,
          "description": "Correlation ID matching the original subscribe request"
        },
        "topics": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "minItems": 1,
          "description": "List of topics that were successfully subscribed"
        }
      }
    },
    "SubscribeErrorData": {
      "type": "object",
      "required": [
        "message_id",
        "error"
      ],
      "properties": {
        "message_id": {
          "type": "string",
          "minLength": 1,
          "description": "Correlation ID matching the original subscribe request"
        },
        "topics": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "List of topics that failed to subscribe"
        },
        "error": {
          "type": "string",
          "minLength": 1,
          "description": "Human-readable error message"
        },
        "error_code": {
          "type": "string",
          "description": "Machine-readable error code (e.g., NOT_FOUND, FORBIDDEN)"
        }
      }
    },
    "UnsubscribeData": {
      "type": "object",
      "required": [
        "topics"
      ],
      "properties": {
        "topics": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "minItems": 1
        },
        "message_id": {
          "type": "string"
        }
      }
    },
    "SendMessageData": {
      "type": "object",
      "required": [
        "thread_id",
        "content"
      ],
      "properties": {
        "thread_id": {
          "type": "integer",
          "minimum": 1
        },
        "content": {
          "type": "string",
          "minLength": 1
        },
        "metadata": {
          "type": "object"
        }
      }
    },
    "ThreadMessageData": {
      "type": "object",
      "required": [
        "thread_id",
        "message"
      ],
      "properties": {
        "thread_id": {
          "type": "integer",
          "minimum": 1
        },
        "message": {
          "type": "object",
          "required": [
            "id",
            "role",
            "content"
          ],
          "properties": {
            "id": {
              "type": "integer",
              "minimum": 1
            },
            "role": {
              "type": "string",
              "enum": [
                "user",
                "assistant",
                "system",
                "tool"
              ]
            },
            "content": {
              "type": "string"
            },
            "metadata": {
              "type": "object"
            },
            "created_at": {
              "type": "string",
              "format": "date-time"
            }
          }
        }
      }
    },
    "ThreadEventData": {
      "type": "object",
      "required": [
        "thread_id"
      ],
      "properties": {
        "thread_id": {
          "type": "integer",
          "minimum": 1
        },
        "agent_id": {
          "type": "integer",
          "minimum": 1
        },
        "title": {
          "type": "string"
        },
        "created_at": {
          "type": "string",
          "format": "date-time"
        },
        "updated_at": {
          "type": "string",
          "format": "date-time"
        }
      }
    },
    "StreamStartData": {
      "type": "object",
      "required": [
        "thread_id"
      ],
      "properties": {
        "thread_id": {
          "type": "integer",
          "minimum": 1
        }
      }
    },
    "StreamChunkData": {
      "type": "object",
      "required": [
        "thread_id",
        "chunk_type"
      ],
      "properties": {
        "thread_id": {
          "type": "integer",
          "minimum": 1
        },
        "chunk_type": {
          "type": "string",
          "enum": [
            "assistant_token",
            "assistant_message",
            "tool_output"
          ]
        },
        "content": {
          "type": "string"
        },
        "tool_name": {
          "type": "string"
        },
        "tool_call_id": {
          "type": "string"
        },
        "message_id": {
          "type": "integer",
          "minimum": 1
        }
      }
    },
    "StreamEndData": {
      "type": "object",
      "required": [
        "thread_id"
      ],
      "properties": {
        "thread_id": {
          "type": "integer",
          "minimum": 1
        }
      }
    },
    "AssistantIdData": {
      "type": "object",
      "required": [
        "thread_id",
        "message_id"
      ],
      "properties": {
        "thread_id": {
          "type": "integer",
          "minimum": 1
        },
        "message_id": {
          "type": "integer",
          "minimum": 1
        }
      }
    },
    "AgentEventData": {
      "type": "object",
      "required": [
        "id"
      ],
      "properties": {
        "id": {
          "type": "integer",
          "minimum": 1
        },
        "status": {
          "type": "string"
        },
        "last_run_at": {
          "type": "string",
          "format": "date-time"
        },
        "next_run_at": {
          "type": "string",
          "format": "date-time"
        },
        "last_error": {
          "type": "string"
        },
        "name": {
          "type": "string"
        },
        "description": {
          "type": "string"
        }
      }
    },
    "RunUpdateData": {
      "type": "object",
      "required": [
        "id",
        "agent_id",
        "status"
      ],
      "properties": {
        "id": {
          "type": "integer",
          "minimum": 1
        },
        "agent_id": {
          "type": "integer",
          "minimum": 1
        },
        "thread_id": {
          "type": "integer",
          "minimum": 1
        },
        "status": {
          "type": "string",
          "enum": [
            "queued",
            "running",
            "success",
            "failed"
          ]
        },
        "trigger": {
          "type": "string",
          "enum": [
            "manual",
            "schedule",
            "chat",
            "webhook",
            "api"
          ]
        },
        "started_at": {
          "type": "string",
          "format": "date-time"
        },
        "finished_at": {
          "type": "string",
          "format": "date-time"
        },
        "duration_ms": {
          "type": "integer",
          "minimum": 0
        },
        "error": {
          "type": "string"
        }
      }
    },
    "UserUpdateData": {
      "type": "object",
      "required": [
        "id"
      ],
      "properties": {
        "id": {
          "type": "integer",
          "minimum": 1
        },
        "email": {
          "type": "string",
          "format": "email"
        },
        "display_name": {
          "type": "string"
        },
        "avatar_url": {
          "type": "string",
          "format": "uri"
        }
      }
    },
    "NodeStateData": {
      "type": "object",
      "required": [
        "execution_id",
        "node_id",
        "phase"
      ],
      "properties": {
        "execution_id": {
          "type": "integer",
          "minimum": 1
        },
        "node_id": {
          "type": "string",
          "minLength": 1
        },
        "phase": {
          "type": "string",
          "enum": [
            "waiting",
            "running",
            "finished"
          ],
          "description": "Current execution phase - what is happening NOW"
        },
        "result": {
          "type": "string",
          "enum": [
            "success",
            "failure",
            "cancelled"
          ],
          "description": "Execution result - how did it END (only when phase=finished)"
        },
        "attempt_no": {
          "type": "integer",
          "minimum": 1,
          "description": "Attempt number for retry tracking"
        },
        "failure_kind": {
          "type": "string",
          "enum": [
            "user",
            "system",
            "timeout",
            "external",
            "unknown"
          ],
          "description": "Classification of failure type (only when result=failure)"
        },
        "error_message": {
          "type": "string",
          "description": "Detailed error message for failures"
        },
        "output": {
          "type": "object"
        }
      }
    },
    "ExecutionFinishedData": {
      "type": "object",
      "required": [
        "execution_id",
        "result"
      ],
      "properties": {
        "execution_id": {
          "type": "integer",
          "minimum": 1
        },
        "result": {
          "type": "string",
          "enum": [
            "success",
            "failure",
            "cancelled"
          ],
          "description": "How the execution ended"
        },
        "attempt_no": {
          "type": "integer",
          "minimum": 1,
          "description": "Final attempt number"
        },
        "failure_kind": {
          "type": "string",
          "enum": [
            "user",
            "system",
            "timeout",
            "external",
            "unknown"
          ],
          "description": "Classification of failure type (only when result=failure)"
        },
        "error_message": {
          "type": "string",
          "description": "Detailed error message for failures"
        },
        "duration_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "Total execution time in milliseconds"
        }
      }
    },
    "NodeLogData": {
      "type": "object",
      "required": [
        "execution_id",
        "node_id",
        "stream",
        "text"
      ],
      "properties": {
        "execution_id": {
          "type": "integer",
          "minimum": 1
        },
        "node_id": {
          "type": "string",
          "minLength": 1
        },
        "stream": {
          "type": "string",
          "enum": [
            "stdout",
            "stderr"
          ]
        },
        "text": {
          "type": "string"
        }
      }
    },
    "OpsEventData": {
      "type": "object",
      "required": [
        "type"
      ],
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "run_started",
            "run_success",
            "run_failed",
            "agent_created",
            "agent_updated",
            "thread_message_created",
            "budget_denied"
          ]
        },
        "agent_id": {
          "type": "integer",
          "minimum": 1
        },
        "run_id": {
          "type": "integer",
          "minimum": 1
        },
        "thread_id": {
          "type": "integer",
          "minimum": 1
        },
        "duration_ms": {
          "type": "integer",
          "minimum": 0
        },
        "error": {
          "type": "string"
        },
        "agent_name": {
          "type": "string"
        },
        "status": {
          "type": "string"
        },
        "scope": {
          "type": "string",
          "enum": [
            "user",
            "global"
          ]
        },
        "percent": {
          "type": "number"
        },
        "used_usd": {
          "type": "number"
        },
        "limit_cents": {
          "type": "integer",
          "minimum": 0
        },
        "user_email": {
          "type": "string",
          "format": "email"
        }
      }
    }
  }
}
