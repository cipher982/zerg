🚀 Setting up test environment...
✅ Pre-test cleanup completed
✅ Test environment setup completed

Running 6 tests using 2 workers

[1A[2K[1/6] [chromium] › tests/canvas_api_contract.spec.ts:13:7 › Canvas API Contract Tests › Canvas endpoint exists and does not return 404
[1A[2K[2/6] [chromium] › tests/agent_creation_full.spec.ts:15:7 › Agent Creation Full Workflow › Complete agent creation and isolation test
[1A[2K[chromium] › tests/agent_creation_full.spec.ts:15:7 › Agent Creation Full Workflow › Complete agent creation and isolation test
🔍 Starting complete agent creation test...

[1A[2K📊 Worker ID: 0

[1A[2K📊 Step 0: Resetting database...

[1A[2K[3/6] [chromium] › tests/canvas_api_contract.spec.ts:42:7 › Canvas API Contract Tests › Wrong canvas-data endpoint returns 404
[1A[2K[2m[WebServer] [22mWARNING:zerg.routers.admin:Resetting database - dropping all tables

[1A[2K✅ Database reset successful

[1A[2K📊 Step 1: Verifying empty state...

[1A[2K[4/6] [chromium] › tests/canvas_api_contract.spec.ts:42:7 › Canvas API Contract Tests › Wrong canvas-data endpoint returns 404 (retry #1)
[1A[2K  1) [chromium] › tests/canvas_api_contract.spec.ts:42:7 › Canvas API Contract Tests › Wrong canvas-data endpoint returns 404 

    Error: [2mexpect([22m[31mreceived[39m[2m).[22mtoBe[2m([22m[32mexpected[39m[2m) // Object.is equality[22m

    Expected: [32m404[39m
    Received: [31m0[39m

      64 |
      65 |     // This SHOULD return 404 to confirm the wrong endpoint doesn't exist
    > 66 |     expect(response.status).toBe(404);
         |                             ^
      67 |   });
      68 |
      69 |   test('Canvas tab loads without network errors', async ({ page }) => {
        at /Users/davidrose/git/zerg/e2e/tests/canvas_api_contract.spec.ts:66:29

    attachment #1: screenshot (image/png) ──────────────────────────────────────────────────────────
    test-results/canvas_api_contract-Canvas-52b50-s-data-endpoint-returns-404-chromium/test-failed-1.png
    ────────────────────────────────────────────────────────────────────────────────────────────────

    Error Context: test-results/canvas_api_contract-Canvas-52b50-s-data-endpoint-returns-404-chromium/error-context.md

    attachment #3: trace (application/zip) ─────────────────────────────────────────────────────────
    test-results/canvas_api_contract-Canvas-52b50-s-data-endpoint-returns-404-chromium/trace.zip
    Usage:

        npx playwright show-trace test-results/canvas_api_contract-Canvas-52b50-s-data-endpoint-returns-404-chromium/trace.zip

    ────────────────────────────────────────────────────────────────────────────────────────────────

    Retry #1 ───────────────────────────────────────────────────────────────────────────────────────

    Error: [2mexpect([22m[31mreceived[39m[2m).[22mtoBe[2m([22m[32mexpected[39m[2m) // Object.is equality[22m

    Expected: [32m404[39m
    Received: [31m0[39m

      64 |
      65 |     // This SHOULD return 404 to confirm the wrong endpoint doesn't exist
    > 66 |     expect(response.status).toBe(404);
         |                             ^
      67 |   });
      68 |
      69 |   test('Canvas tab loads without network errors', async ({ page }) => {
        at /Users/davidrose/git/zerg/e2e/tests/canvas_api_contract.spec.ts:66:29

    attachment #1: screenshot (image/png) ──────────────────────────────────────────────────────────
    test-results/canvas_api_contract-Canvas-52b50-s-data-endpoint-returns-404-chromium-retry1/test-failed-1.png
    ────────────────────────────────────────────────────────────────────────────────────────────────

    Error Context: test-results/canvas_api_contract-Canvas-52b50-s-data-endpoint-returns-404-chromium-retry1/error-context.md

    attachment #3: trace (application/zip) ─────────────────────────────────────────────────────────
    test-results/canvas_api_contract-Canvas-52b50-s-data-endpoint-returns-404-chromium-retry1/trace.zip
    Usage:

        npx playwright show-trace test-results/canvas_api_contract-Canvas-52b50-s-data-endpoint-returns-404-chromium-retry1/trace.zip

    ────────────────────────────────────────────────────────────────────────────────────────────────


[1A[2K📊 Initial agent count: [33m0[39m

[1A[2K📊 Step 2: Creating agent via API...

[1A[2K📊 Agent creation status: [33m500[39m

[1A[2K📊 Agent creation error: Internal Server Error

[1A[2K[2m[WebServer] [22mERROR:    Exception in ASGI application
[2m[WebServer] [22mTraceback (most recent call last):
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
[2m[WebServer] [22m    result = await app(  # type: ignore[func-returns-value]
[2m[WebServer] [22m             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[2m[WebServer] [22m        self.scope, self.receive, self.send
[2m[WebServer] [22m        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[2m[WebServer] [22m    )
[2m[WebServer] [22m    ^
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/uvicorn/middleware/proxy_headers.py", line 84, in __call__
[2m[WebServer] [22m    return await self.app(scope, receive, send)
[2m[WebServer] [22m           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/fastapi/applications.py", line 1054, in __call__
[2m[WebServer] [22m    await super().__call__(scope, receive, send)
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/applications.py", line 112, in __call__
[2m[WebServer] [22m    await self.middleware_stack(scope, receive, send)
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 187, in __call__
[2m[WebServer] [22m    raise exc
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
[2m[WebServer] [22m    await self.app(scope, receive, _send)
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py", line 85, in __call__
[2m[WebServer] [22m    await self.app(scope, receive, send)
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
[2m[WebServer] [22m    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
[2m[WebServer] [22m    raise exc
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
[2m[WebServer] [22m    await app(scope, receive, sender)
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/routing.py", line 714, in __call__
[2m[WebServer] [22m    await self.middleware_stack(scope, receive, send)
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/routing.py", line 734, in app
[2m[WebServer] [22m    await route.handle(scope, receive, send)
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/routing.py", line 288, in handle
[2m[WebServer] [22m    await self.app(scope, receive, send)
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/routing.py", line 76, in app
[2m[WebServer] [22m    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
[2m[WebServer] [22m    raise exc
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
[2m[WebServer] [22m    await app(scope, receive, sender)
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/routing.py", line 73, in app
[2m[WebServer] [22m    response = await f(request)
[2m[WebServer] [22m               ^^^^^^^^^^^^^^^^
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/fastapi/routing.py", line 301, in app
[2m[WebServer] [22m    raw_response = await run_endpoint_function(
[2m[WebServer] [22m                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[2m[WebServer] [22m    ...<3 lines>...
[2m[WebServer] [22m    )
[2m[WebServer] [22m    ^
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
[2m[WebServer] [22m    return await dependant.call(**values)
[2m[WebServer] [22m           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/zerg/core/routers.py", line 90, in create_agent
[2m[WebServer] [22m    return await agent_service.create_agent(
[2m[WebServer] [22m           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[2m[WebServer] [22m    ...<7 lines>...
[2m[WebServer] [22m    )
[2m[WebServer] [22m    ^
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/zerg/core/services.py", line 90, in create_agent
[2m[WebServer] [22m    agent_id = agent.id
[2m[WebServer] [22m               ^^^^^^^^
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/sqlalchemy/orm/attributes.py", line 566, in __get__
[2m[WebServer] [22m    return self.impl.get(state, dict_)  # type: ignore[no-any-return]
[2m[WebServer] [22m           ~~~~~~~~~~~~~^^^^^^^^^^^^^^
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/sqlalchemy/orm/attributes.py", line 1086, in get
[2m[WebServer] [22m    value = self._fire_loader_callables(state, key, passive)
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/sqlalchemy/orm/attributes.py", line 1116, in _fire_loader_callables
[2m[WebServer] [22m    return state._load_expired(state, passive)
[2m[WebServer] [22m           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/sqlalchemy/orm/state.py", line 803, in _load_expired
[2m[WebServer] [22m    self.manager.expired_attribute_loader(self, toload, passive)
[2m[WebServer] [22m    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/sqlalchemy/orm/loading.py", line 1603, in load_scalar_attributes
[2m[WebServer] [22m    raise orm_exc.DetachedInstanceError(
[2m[WebServer] [22m    ...<2 lines>...
[2m[WebServer] [22m    )
[2m[WebServer] [22msqlalchemy.orm.exc.DetachedInstanceError: Instance <Agent at 0x105a72cf0> is not bound to a Session; attribute refresh operation cannot proceed (Background on this error at: https://sqlalche.me/e/20/bhk3)

[1A[2K[5/6] [chromium] › tests/canvas_api_contract.spec.ts:69:7 › Canvas API Contract Tests › Canvas tab loads without network errors
[1A[2K[6/6] [chromium] › tests/agent_creation_full.spec.ts:15:7 › Agent Creation Full Workflow › Complete agent creation and isolation test (retry #1)
[1A[2K[7/6] (retries) [chromium] › tests/canvas_complete_workflow.spec.ts:17:7 › Complete Canvas Workflow › End-to-end canvas workflow with agent and tool execution
[1A[2K[chromium] › tests/canvas_complete_workflow.spec.ts:17:7 › Complete Canvas Workflow › End-to-end canvas workflow with agent and tool execution
🚀 Starting complete canvas workflow test...

[1A[2K📊 Worker ID: 3

[1A[2K📊 Step 1: Creating test agent...

[1A[2K[chromium] › tests/agent_creation_full.spec.ts:15:7 › Agent Creation Full Workflow › Complete agent creation and isolation test
🔍 Starting complete agent creation test...

[1A[2K📊 Worker ID: 4

[1A[2K📊 Step 0: Resetting database...

[1A[2K[2m[WebServer] [22mERROR:    Exception in ASGI application
[2m[WebServer] [22mTraceback (most recent call last):
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
[2m[WebServer] [22m    result = await app(  # type: ignore[func-returns-value]
[2m[WebServer] [22m             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[2m[WebServer] [22m        self.scope, self.receive, self.send
[2m[WebServer] [22m        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[2m[WebServer] [22m    )
[2m[WebServer] [22m    ^
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/uvicorn/middleware/proxy_headers.py", line 84, in __call__
[2m[WebServer] [22m    return await self.app(scope, receive, send)
[2m[WebServer] [22m           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/fastapi/applications.py", line 1054, in __call__
[2m[WebServer] [22m    await super().__call__(scope, receive, send)
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/applications.py", line 112, in __call__
[2m[WebServer] [22m    await self.middleware_stack(scope, receive, send)
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 187, in __call__
[2m[WebServer] [22m    raise exc
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
[2m[WebServer] [22m    await self.app(scope, receive, _send)
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py", line 85, in __call__
[2m[WebServer] [22m    await self.app(scope, receive, send)
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
[2m[WebServer] [22m    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
[2m[WebServer] [22m    raise exc
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
[2m[WebServer] [22m    await app(scope, receive, sender)
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/routing.py", line 714, in __call__
[2m[WebServer] [22m    await self.middleware_stack(scope, receive, send)
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/routing.py", line 734, in app
[2m[WebServer] [22m    await route.handle(scope, receive, send)
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/routing.py", line 288, in handle
[2m[WebServer] [22m    await self.app(scope, receive, send)
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/routing.py", line 76, in app
[2m[WebServer] [22m    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
[2m[WebServer] [22m    raise exc
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
[2m[WebServer] [22m    await app(scope, receive, sender)
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/routing.py", line 73, in app
[2m[WebServer] [22m    response = await f(request)
[2m[WebServer] [22m               ^^^^^^^^^^^^^^^^
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/fastapi/routing.py", line 301, in app
[2m[WebServer] [22m    raw_response = await run_endpoint_function(
[2m[WebServer] [22m                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[2m[WebServer] [22m    ...<3 lines>...
[2m[WebServer] [22m    )
[2m[WebServer] [22m    ^
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
[2m[WebServer] [22m    return await dependant.call(**values)
[2m[WebServer] [22m           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/zerg/core/routers.py", line 90, in create_agent
[2m[WebServer] [22m    return await agent_service.create_agent(
[2m[WebServer] [22m           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[2m[WebServer] [22m    ...<7 lines>...
[2m[WebServer] [22m    )
[2m[WebServer] [22m    ^
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/zerg/core/services.py", line 90, in create_agent
[2m[WebServer] [22m    agent_id = agent.id
[2m[WebServer] [22m               ^^^^^^^^
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/sqlalchemy/orm/attributes.py", line 566, in __get__
[2m[WebServer] [22m    return self.impl.get(state, dict_)  # type: ignore[no-any-return]
[2m[WebServer] [22m           ~~~~~~~~~~~~~^^^^^^^^^^^^^^
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/sqlalchemy/orm/attributes.py", line 1086, in get
[2m[WebServer] [22m    value = self._fire_loader_callables(state, key, passive)
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/sqlalchemy/orm/attributes.py", line 1116, in _fire_loader_callables
[2m[WebServer] [22m    return state._load_expired(state, passive)
[2m[WebServer] [22m           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/sqlalchemy/orm/state.py", line 803, in _load_expired
[2m[WebServer] [22m    self.manager.expired_attribute_loader(self, toload, passive)
[2m[WebServer] [22m    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/sqlalchemy/orm/loading.py", line 1603, in load_scalar_attributes
[2m[WebServer] [22m    raise orm_exc.DetachedInstanceError(
[2m[WebServer] [22m    ...<2 lines>...
[2m[WebServer] [22m    )
[2m[WebServer] [22msqlalchemy.orm.exc.DetachedInstanceError: Instance <Agent at 0x105a8f890> is not bound to a Session; attribute refresh operation cannot proceed (Background on this error at: https://sqlalche.me/e/20/bhk3)

[1A[2KDatabase reset attempt 1 failed: apiRequestContext.post: connect ECONNREFUSED ::1:8005
Call log:
[2m  - → POST http://localhost:8005/api/admin/reset-database[22m
[2m    - user-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.7103.25 Safari/537.36[22m
[2m    - accept: */*[22m
[2m    - accept-encoding: gzip,deflate,br[22m
[2m    - X-Test-Worker: 4[22m

    at resetDatabaseViaRequest [90m(/Users/davidrose/git/zerg/e2e/[39mtests/helpers/database-helpers.ts:97:43[90m)[39m
    at [90m/Users/davidrose/git/zerg/e2e/[39mtests/agent_creation_full.spec.ts:25:36 {
  name: [32m'Error'[39m,
  [[32mSymbol(step)[39m]: {
    stepId: [32m'pw:api@12'[39m,
    location: {
      file: [32m'/Users/davidrose/git/zerg/e2e/tests/helpers/database-helpers.ts'[39m,
      line: [33m97[39m,
      column: [33m43[39m,
      function: [32m'resetDatabaseViaRequest'[39m
    },
    category: [32m'pw:api'[39m,
    title: [32m'apiRequestContext.post(http://localhost:8005/api/admin/reset-database)'[39m,
    apiName: [32m'apiRequestContext.post'[39m,
    params: {
      url: [32m'http://localhost:8005/api/admin/reset-database'[39m,
      params: [90mundefined[39m,
      encodedParams: [90mundefined[39m,
      method: [32m'POST'[39m,
      headers: [90mundefined[39m,
      postData: [90mundefined[39m,
      jsonData: [90mundefined[39m,
      formData: [90mundefined[39m,
      multipartData: [90mundefined[39m,
      timeout: [90mundefined[39m,
      failOnStatusCode: [90mundefined[39m,
      ignoreHTTPSErrors: [90mundefined[39m,
      maxRedirects: [90mundefined[39m,
      maxRetries: [90mundefined[39m,
      __testHookLookup: [90mundefined[39m
    },
    boxedStack: [90mundefined[39m,
    steps: [],
    attachmentIndices: [],
    info: TestStepInfoImpl {
      annotations: [],
      _testInfo: [36m[TestInfoImpl][39m,
      _stepId: [32m'pw:api@12'[39m
    },
    complete: [36m[Function: complete][39m,
    endWallTime: [33m1754919997040[39m,
    error: {
      message: [32m'Error: apiRequestContext.post: connect ECONNREFUSED ::1:8005\n'[39m +
        [32m'Call log:\n'[39m +
        [32m'\x1B[2m  - → POST http://localhost:8005/api/admin/reset-database\x1B[22m\n'[39m +
        [32m'\x1B[2m    - user-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.7103.25 Safari/537.36\x1B[22m\n'[39m +
        [32m'\x1B[2m    - accept: */*\x1B[22m\n'[39m +
        [32m'\x1B[2m    - accept-encoding: gzip,deflate,br\x1B[22m\n'[39m +
        [32m'\x1B[2m    - X-Test-Worker: 4\x1B[22m\n'[39m,
      stack: [32m'Error: apiRequestContext.post: connect ECONNREFUSED ::1:8005\n'[39m +
        [32m'Call log:\n'[39m +
        [32m'\x1B[2m  - → POST http://localhost:8005/api/admin/reset-database\x1B[22m\n'[39m +
        [32m'\x1B[2m    - user-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.7103.25 Safari/537.36\x1B[22m\n'[39m +
        [32m'\x1B[2m    - accept: */*\x1B[22m\n'[39m +
        [32m'\x1B[2m    - accept-encoding: gzip,deflate,br\x1B[22m\n'[39m +
        [32m'\x1B[2m    - X-Test-Worker: 4\x1B[22m\n'[39m +
        [32m'\n'[39m +
        [32m'    at apiRequestContext.post: connect ECONNREFUSED ::1:8005\n'[39m +
        [32m'    at resetDatabaseViaRequest (/Users/davidrose/git/zerg/e2e/tests/helpers/database-helpers.ts:97:43)\n'[39m +
        [32m'    at /Users/davidrose/git/zerg/e2e/tests/agent_creation_full.spec.ts:25:36'[39m,
      cause: [90mundefined[39m
    }
  }
}

[1A[2K[8/6] (retries) [chromium] › tests/canvas_complete_workflow.spec.ts:17:7 › Complete Canvas Workflow › End-to-end canvas workflow with agent and tool execution (retry #1)
[1A[2K[chromium] › tests/canvas_complete_workflow.spec.ts:17:7 › Complete Canvas Workflow › End-to-end canvas workflow with agent and tool execution
🚀 Starting complete canvas workflow test...

[1A[2K📊 Worker ID: 5

[1A[2K📊 Step 1: Creating test agent...

[1A[2K[2m[WebServer] [22mERROR:    Exception in ASGI application
[2m[WebServer] [22mTraceback (most recent call last):
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/uvicorn/protocols/http/h11_impl.py", line 408, in run_asgi
[2m[WebServer] [22m    result = await app(  # type: ignore[func-returns-value]
[2m[WebServer] [22m             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[2m[WebServer] [22m        self.scope, self.receive, self.send
[2m[WebServer] [22m        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[2m[WebServer] [22m    )
[2m[WebServer] [22m    ^
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/uvicorn/middleware/proxy_headers.py", line 84, in __call__
[2m[WebServer] [22m    return await self.app(scope, receive, send)
[2m[WebServer] [22m           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/fastapi/applications.py", line 1054, in __call__
[2m[WebServer] [22m    await super().__call__(scope, receive, send)
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/applications.py", line 112, in __call__
[2m[WebServer] [22m    await self.middleware_stack(scope, receive, send)
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 187, in __call__
[2m[WebServer] [22m    raise exc
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
[2m[WebServer] [22m    await self.app(scope, receive, _send)
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/middleware/cors.py", line 85, in __call__
[2m[WebServer] [22m    await self.app(scope, receive, send)
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py", line 62, in __call__
[2m[WebServer] [22m    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
[2m[WebServer] [22m    raise exc
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
[2m[WebServer] [22m    await app(scope, receive, sender)
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/routing.py", line 714, in __call__
[2m[WebServer] [22m    await self.middleware_stack(scope, receive, send)
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/routing.py", line 734, in app
[2m[WebServer] [22m    await route.handle(scope, receive, send)
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/routing.py", line 288, in handle
[2m[WebServer] [22m    await self.app(scope, receive, send)
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/routing.py", line 76, in app
[2m[WebServer] [22m    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
[2m[WebServer] [22m    raise exc
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
[2m[WebServer] [22m    await app(scope, receive, sender)
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/starlette/routing.py", line 73, in app
[2m[WebServer] [22m    response = await f(request)
[2m[WebServer] [22m               ^^^^^^^^^^^^^^^^
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/fastapi/routing.py", line 301, in app
[2m[WebServer] [22m    raw_response = await run_endpoint_function(
[2m[WebServer] [22m                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[2m[WebServer] [22m    ...<3 lines>...
[2m[WebServer] [22m    )
[2m[WebServer] [22m    ^
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/fastapi/routing.py", line 212, in run_endpoint_function
[2m[WebServer] [22m    return await dependant.call(**values)
[2m[WebServer] [22m           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/zerg/core/routers.py", line 90, in create_agent
[2m[WebServer] [22m    return await agent_service.create_agent(
[2m[WebServer] [22m           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[2m[WebServer] [22m    ...<7 lines>...
[2m[WebServer] [22m    )
[2m[WebServer] [22m    ^
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/zerg/core/services.py", line 90, in create_agent
[2m[WebServer] [22m    agent_id = agent.id
[2m[WebServer] [22m               ^^^^^^^^
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/sqlalchemy/orm/attributes.py", line 566, in __get__
[2m[WebServer] [22m    return self.impl.get(state, dict_)  # type: ignore[no-any-return]
[2m[WebServer] [22m           ~~~~~~~~~~~~~^^^^^^^^^^^^^^
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/sqlalchemy/orm/attributes.py", line 1086, in get
[2m[WebServer] [22m    value = self._fire_loader_callables(state, key, passive)
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/sqlalchemy/orm/attributes.py", line 1116, in _fire_loader_callables
[2m[WebServer] [22m    return state._load_expired(state, passive)
[2m[WebServer] [22m           ~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/sqlalchemy/orm/state.py", line 803, in _load_expired
[2m[WebServer] [22m    self.manager.expired_attribute_loader(self, toload, passive)
[2m[WebServer] [22m    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
[2m[WebServer] [22m  File "/Users/davidrose/git/zerg/backend/.venv/lib/python3.13/site-packages/sqlalchemy/orm/loading.py", line 1603, in load_scalar_attributes
[2m[WebServer] [22m    raise orm_exc.DetachedInstanceError(
[2m[WebServer] [22m    ...<2 lines>...
[2m[WebServer] [22m    )
[2m[WebServer] [22msqlalchemy.orm.exc.DetachedInstanceError: Instance <Agent at 0x1059cb250> is not bound to a Session; attribute refresh operation cannot proceed (Background on this error at: https://sqlalche.me/e/20/bhk3)

[1A[2K  2) [chromium] › tests/canvas_complete_workflow.spec.ts:17:7 › Complete Canvas Workflow › End-to-end canvas workflow with agent and tool execution 

    Error: [2mexpect([22m[31mreceived[39m[2m).[22mtoBe[2m([22m[32mexpected[39m[2m) // Object.is equality[22m

    Expected: [32m201[39m
    Received: [31m500[39m

      32 |     });
      33 |     
    > 34 |     expect(agentResponse.status()).toBe(201);
         |                                    ^
      35 |     const createdAgent = await agentResponse.json();
      36 |     console.log('✅ Test agent created with ID:', createdAgent.id);
      37 |     
        at /Users/davidrose/git/zerg/e2e/tests/canvas_complete_workflow.spec.ts:34:36

    attachment #1: screenshot (image/png) ──────────────────────────────────────────────────────────
    test-results/canvas_complete_workflow-C-c6777-th-agent-and-tool-execution-chromium/test-failed-1.png
    ────────────────────────────────────────────────────────────────────────────────────────────────

    Error Context: test-results/canvas_complete_workflow-C-c6777-th-agent-and-tool-execution-chromium/error-context.md

    attachment #3: trace (application/zip) ─────────────────────────────────────────────────────────
    test-results/canvas_complete_workflow-C-c6777-th-agent-and-tool-execution-chromium/trace.zip
    Usage:

        npx playwright show-trace test-results/canvas_complete_workflow-C-c6777-th-agent-and-tool-execution-chromium/trace.zip

    ────────────────────────────────────────────────────────────────────────────────────────────────

    Retry #1 ───────────────────────────────────────────────────────────────────────────────────────

    Error: [2mexpect([22m[31mreceived[39m[2m).[22mtoBe[2m([22m[32mexpected[39m[2m) // Object.is equality[22m

    Expected: [32m201[39m
    Received: [31m500[39m

      32 |     });
      33 |     
    > 34 |     expect(agentResponse.status()).toBe(201);
         |                                    ^
      35 |     const createdAgent = await agentResponse.json();
      36 |     console.log('✅ Test agent created with ID:', createdAgent.id);
      37 |     
        at /Users/davidrose/git/zerg/e2e/tests/canvas_complete_workflow.spec.ts:34:36

    attachment #1: screenshot (image/png) ──────────────────────────────────────────────────────────
    test-results/canvas_complete_workflow-C-c6777-th-agent-and-tool-execution-chromium-retry1/test-failed-1.png
    ────────────────────────────────────────────────────────────────────────────────────────────────

    Error Context: test-results/canvas_complete_workflow-C-c6777-th-agent-and-tool-execution-chromium-retry1/error-context.md

    attachment #3: trace (application/zip) ─────────────────────────────────────────────────────────
    test-results/canvas_complete_workflow-C-c6777-th-agent-and-tool-execution-chromium-retry1/trace.zip
    Usage:

        npx playwright show-trace test-results/canvas_complete_workflow-C-c6777-th-agent-and-tool-execution-chromium-retry1/trace.zip

    ────────────────────────────────────────────────────────────────────────────────────────────────


[1A[2K[9/6] (retries) [chromium] › tests/comprehensive_debug.spec.ts:16:7 › Comprehensive Debug › Complete system debug and diagnosis
[1A[2K[chromium] › tests/comprehensive_debug.spec.ts:16:7 › Comprehensive Debug › Complete system debug and diagnosis
🔍 Starting comprehensive debug test...

[1A[2K📊 Worker ID: 6

[1A[2K📊 NODE_ENV: test

[1A[2K🚀 Starting isolated backend server...

[1A[2K[backend-server] Starting backend for worker 6 on port 8007

[1A[2K[chromium] › tests/agent_creation_full.spec.ts:15:7 › Agent Creation Full Workflow › Complete agent creation and isolation test
Database reset attempt 2 failed: apiRequestContext.post: connect ECONNREFUSED ::1:8005
Call log:
[2m  - → POST http://localhost:8005/api/admin/reset-database[22m
[2m    - user-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.7103.25 Safari/537.36[22m
[2m    - accept: */*[22m
[2m    - accept-encoding: gzip,deflate,br[22m
[2m    - X-Test-Worker: 4[22m

    at resetDatabaseViaRequest [90m(/Users/davidrose/git/zerg/e2e/[39mtests/helpers/database-helpers.ts:97:43[90m)[39m
    at [90m/Users/davidrose/git/zerg/e2e/[39mtests/agent_creation_full.spec.ts:25:7 {
  name: [32m'Error'[39m,
  [[32mSymbol(step)[39m]: {
    stepId: [32m'pw:api@13'[39m,
    location: {
      file: [32m'/Users/davidrose/git/zerg/e2e/tests/helpers/database-helpers.ts'[39m,
      line: [33m97[39m,
      column: [33m43[39m,
      function: [32m'resetDatabaseViaRequest'[39m
    },
    category: [32m'pw:api'[39m,
    title: [32m'apiRequestContext.post(http://localhost:8005/api/admin/reset-database)'[39m,
    apiName: [32m'apiRequestContext.post'[39m,
    params: {
      url: [32m'http://localhost:8005/api/admin/reset-database'[39m,
      params: [90mundefined[39m,
      encodedParams: [90mundefined[39m,
      method: [32m'POST'[39m,
      headers: [90mundefined[39m,
      postData: [90mundefined[39m,
      jsonData: [90mundefined[39m,
      formData: [90mundefined[39m,
      multipartData: [90mundefined[39m,
      timeout: [90mundefined[39m,
      failOnStatusCode: [90mundefined[39m,
      ignoreHTTPSErrors: [90mundefined[39m,
      maxRedirects: [90mundefined[39m,
      maxRetries: [90mundefined[39m,
      __testHookLookup: [90mundefined[39m
    },
    boxedStack: [90mundefined[39m,
    steps: [],
    attachmentIndices: [],
    info: TestStepInfoImpl {
      annotations: [],
      _testInfo: [36m[TestInfoImpl][39m,
      _stepId: [32m'pw:api@13'[39m
    },
    complete: [36m[Function: complete][39m,
    endWallTime: [33m1754919998346[39m,
    error: {
      message: [32m'Error: apiRequestContext.post: connect ECONNREFUSED ::1:8005\n'[39m +
        [32m'Call log:\n'[39m +
        [32m'\x1B[2m  - → POST http://localhost:8005/api/admin/reset-database\x1B[22m\n'[39m +
        [32m'\x1B[2m    - user-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.7103.25 Safari/537.36\x1B[22m\n'[39m +
        [32m'\x1B[2m    - accept: */*\x1B[22m\n'[39m +
        [32m'\x1B[2m    - accept-encoding: gzip,deflate,br\x1B[22m\n'[39m +
        [32m'\x1B[2m    - X-Test-Worker: 4\x1B[22m\n'[39m,
      stack: [32m'Error: apiRequestContext.post: connect ECONNREFUSED ::1:8005\n'[39m +
        [32m'Call log:\n'[39m +
        [32m'\x1B[2m  - → POST http://localhost:8005/api/admin/reset-database\x1B[22m\n'[39m +
        [32m'\x1B[2m    - user-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.7103.25 Safari/537.36\x1B[22m\n'[39m +
        [32m'\x1B[2m    - accept: */*\x1B[22m\n'[39m +
        [32m'\x1B[2m    - accept-encoding: gzip,deflate,br\x1B[22m\n'[39m +
        [32m'\x1B[2m    - X-Test-Worker: 4\x1B[22m\n'[39m +
        [32m'\n'[39m +
        [32m'    at apiRequestContext.post: connect ECONNREFUSED ::1:8005\n'[39m +
        [32m'    at resetDatabaseViaRequest (/Users/davidrose/git/zerg/e2e/tests/helpers/database-helpers.ts:97:43)\n'[39m +
        [32m'    at /Users/davidrose/git/zerg/e2e/tests/agent_creation_full.spec.ts:25:7'[39m,
      cause: [90mundefined[39m
    }
  }
}

[1A[2K[chromium] › tests/comprehensive_debug.spec.ts:16:7 › Comprehensive Debug › Complete system debug and diagnosis
[backend-server] Backend ready for worker 6 at http://localhost:8007

[1A[2K📊 Backend URL: http://localhost:8007

[1A[2K🔍 Test 1: Basic connectivity

[1A[2K📊 Basic connectivity status: [33m200[39m

[1A[2K✅ Backend is accessible

[1A[2K🔍 Test 2: Header transmission

[1A[2K📊 Header transmission status: [33m200[39m

[1A[2K✅ Headers can be sent

[1A[2K🔍 Test 3: Agent GET endpoint

[1A[2K[chromium] › tests/agent_creation_full.spec.ts:15:7 › Agent Creation Full Workflow › Complete agent creation and isolation test
Database reset attempt 3 failed: apiRequestContext.post: connect ECONNREFUSED ::1:8005
Call log:
[2m  - → POST http://localhost:8005/api/admin/reset-database[22m
[2m    - user-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.7103.25 Safari/537.36[22m
[2m    - accept: */*[22m
[2m    - accept-encoding: gzip,deflate,br[22m
[2m    - X-Test-Worker: 4[22m

    at resetDatabaseViaRequest [90m(/Users/davidrose/git/zerg/e2e/[39mtests/helpers/database-helpers.ts:97:43[90m)[39m
    at [90m/Users/davidrose/git/zerg/e2e/[39mtests/agent_creation_full.spec.ts:25:7 {
  name: [32m'Error'[39m,
  [[32mSymbol(step)[39m]: {
    stepId: [32m'pw:api@14'[39m,
    location: {
      file: [32m'/Users/davidrose/git/zerg/e2e/tests/helpers/database-helpers.ts'[39m,
      line: [33m97[39m,
      column: [33m43[39m,
      function: [32m'resetDatabaseViaRequest'[39m
    },
    category: [32m'pw:api'[39m,
    title: [32m'apiRequestContext.post(http://localhost:8005/api/admin/reset-database)'[39m,
    apiName: [32m'apiRequestContext.post'[39m,
    params: {
      url: [32m'http://localhost:8005/api/admin/reset-database'[39m,
      params: [90mundefined[39m,
      encodedParams: [90mundefined[39m,
      method: [32m'POST'[39m,
      headers: [90mundefined[39m,
      postData: [90mundefined[39m,
      jsonData: [90mundefined[39m,
      formData: [90mundefined[39m,
      multipartData: [90mundefined[39m,
      timeout: [90mundefined[39m,
      failOnStatusCode: [90mundefined[39m,
      ignoreHTTPSErrors: [90mundefined[39m,
      maxRedirects: [90mundefined[39m,
      maxRetries: [90mundefined[39m,
      __testHookLookup: [90mundefined[39m
    },
    boxedStack: [90mundefined[39m,
    steps: [],
    attachmentIndices: [],
    info: TestStepInfoImpl {
      annotations: [],
      _testInfo: [36m[TestInfoImpl][39m,
      _stepId: [32m'pw:api@14'[39m
    },
    complete: [36m[Function: complete][39m,
    endWallTime: [33m1754919999651[39m,
    error: {
      message: [32m'Error: apiRequestContext.post: connect ECONNREFUSED ::1:8005\n'[39m +
        [32m'Call log:\n'[39m +
        [32m'\x1B[2m  - → POST http://localhost:8005/api/admin/reset-database\x1B[22m\n'[39m +
        [32m'\x1B[2m    - user-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.7103.25 Safari/537.36\x1B[22m\n'[39m +
        [32m'\x1B[2m    - accept: */*\x1B[22m\n'[39m +
        [32m'\x1B[2m    - accept-encoding: gzip,deflate,br\x1B[22m\n'[39m +
        [32m'\x1B[2m    - X-Test-Worker: 4\x1B[22m\n'[39m,
      stack: [32m'Error: apiRequestContext.post: connect ECONNREFUSED ::1:8005\n'[39m +
        [32m'Call log:\n'[39m +
        [32m'\x1B[2m  - → POST http://localhost:8005/api/admin/reset-database\x1B[22m\n'[39m +
        [32m'\x1B[2m    - user-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.7103.25 Safari/537.36\x1B[22m\n'[39m +
        [32m'\x1B[2m    - accept: */*\x1B[22m\n'[39m +
        [32m'\x1B[2m    - accept-encoding: gzip,deflate,br\x1B[22m\n'[39m +
        [32m'\x1B[2m    - X-Test-Worker: 4\x1B[22m\n'[39m +
        [32m'\n'[39m +
        [32m'    at apiRequestContext.post: connect ECONNREFUSED ::1:8005\n'[39m +
        [32m'    at resetDatabaseViaRequest (/Users/davidrose/git/zerg/e2e/tests/helpers/database-helpers.ts:97:43)\n'[39m +
        [32m'    at /Users/davidrose/git/zerg/e2e/tests/agent_creation_full.spec.ts:25:7'[39m,
      cause: [90mundefined[39m
    }
  }
}

[1A[2K⚠️  Database reset failed: Error: Failed to reset database via request after 3 attempts
    at resetDatabaseViaRequest [90m(/Users/davidrose/git/zerg/e2e/[39mtests/helpers/database-helpers.ts:112:9[90m)[39m
    at [90m/Users/davidrose/git/zerg/e2e/[39mtests/agent_creation_full.spec.ts:25:7
    at [90m/Users/davidrose/git/zerg/e2e/[39mnode_modules/[4mplaywright[24m/lib/worker/workerMain.js:304:9
    at [90m/Users/davidrose/git/zerg/e2e/[39mnode_modules/[4mplaywright[24m/lib/worker/testInfo.js:277:11
    at TimeoutManager.withRunnable [90m(/Users/davidrose/git/zerg/e2e/[39mnode_modules/[4mplaywright[24m/lib/worker/timeoutManager.js:67:14[90m)[39m
    at TestInfoImpl._runWithTimeout [90m(/Users/davidrose/git/zerg/e2e/[39mnode_modules/[4mplaywright[24m/lib/worker/testInfo.js:275:7[90m)[39m
    at [90m/Users/davidrose/git/zerg/e2e/[39mnode_modules/[4mplaywright[24m/lib/worker/workerMain.js:302:7
    at WorkerMain._runTest [90m(/Users/davidrose/git/zerg/e2e/[39mnode_modules/[4mplaywright[24m/lib/worker/workerMain.js:277:5[90m)[39m
    at WorkerMain.runTestGroup [90m(/Users/davidrose/git/zerg/e2e/[39mnode_modules/[4mplaywright[24m/lib/worker/workerMain.js:193:11[90m)[39m
    at process.<anonymous> [90m(/Users/davidrose/git/zerg/e2e/[39mnode_modules/[4mplaywright[24m/lib/common/process.js:70:22[90m)[39m

[1A[2K📊 Step 1: Verifying empty state...

[1A[2K[chromium] › tests/comprehensive_debug.spec.ts:16:7 › Comprehensive Debug › Complete system debug and diagnosis
📊 Agent GET status: [33m500[39m

[1A[2K❌ Agent GET failed: Internal Server Error

[1A[2K🔍 Test 4: Testing different database operations

[1A[2K📊 Testing user endpoint...

[1A[2K📊 User endpoint error: apiRequestContext.get: read ECONNRESET
Call log:
[2m  - → GET http://localhost:8007/api/users/me[22m
[2m    - user-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.7103.25 Safari/537.36[22m
[2m    - accept: */*[22m
[2m    - accept-encoding: gzip,deflate,br[22m
[2m    - X-Test-Worker: 6[22m

    at [90m/Users/davidrose/git/zerg/e2e/[39mtests/comprehensive_debug.spec.ts:90:47 {
  name: [32m'Error'[39m,
  [[32mSymbol(step)[39m]: {
    stepId: [32m'pw:api@12'[39m,
    location: {
      file: [32m'/Users/davidrose/git/zerg/e2e/tests/comprehensive_debug.spec.ts'[39m,
      line: [33m90[39m,
      column: [33m47[39m
    },
    category: [32m'pw:api'[39m,
    title: [32m'apiRequestContext.get(http://localhost:8007/api/users/me)'[39m,
    apiName: [32m'apiRequestContext.get'[39m,
    params: {
      url: [32m'http://localhost:8007/api/users/me'[39m,
      params: [90mundefined[39m,
      encodedParams: [90mundefined[39m,
      method: [32m'GET'[39m,
      headers: [90mundefined[39m,
      postData: [90mundefined[39m,
      jsonData: [90mundefined[39m,
      formData: [90mundefined[39m,
      multipartData: [90mundefined[39m,
      timeout: [90mundefined[39m,
      failOnStatusCode: [90mundefined[39m,
      ignoreHTTPSErrors: [90mundefined[39m,
      maxRedirects: [90mundefined[39m,
      maxRetries: [90mundefined[39m,
      __testHookLookup: [90mundefined[39m
    },
    boxedStack: [90mundefined[39m,
    steps: [],
    attachmentIndices: [],
    info: TestStepInfoImpl {
      annotations: [],
      _testInfo: [36m[TestInfoImpl][39m,
      _stepId: [32m'pw:api@12'[39m
    },
    complete: [36m[Function: complete][39m,
    endWallTime: [33m1754919999689[39m,
    error: {
      message: [32m'Error: apiRequestContext.get: read ECONNRESET\n'[39m +
        [32m'Call log:\n'[39m +
        [32m'\x1B[2m  - → GET http://localhost:8007/api/users/me\x1B[22m\n'[39m +
        [32m'\x1B[2m    - user-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.7103.25 Safari/537.36\x1B[22m\n'[39m +
        [32m'\x1B[2m    - accept: */*\x1B[22m\n'[39m +
        [32m'\x1B[2m    - accept-encoding: gzip,deflate,br\x1B[22m\n'[39m +
        [32m'\x1B[2m    - X-Test-Worker: 6\x1B[22m\n'[39m,
      stack: [32m'Error: apiRequestContext.get: read ECONNRESET\n'[39m +
        [32m'Call log:\n'[39m +
        [32m'\x1B[2m  - → GET http://localhost:8007/api/users/me\x1B[22m\n'[39m +
        [32m'\x1B[2m    - user-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.7103.25 Safari/537.36\x1B[22m\n'[39m +
        [32m'\x1B[2m    - accept: */*\x1B[22m\n'[39m +
        [32m'\x1B[2m    - accept-encoding: gzip,deflate,br\x1B[22m\n'[39m +
        [32m'\x1B[2m    - X-Test-Worker: 6\x1B[22m\n'[39m +
        [32m'\n'[39m +
        [32m'    at /Users/davidrose/git/zerg/e2e/tests/comprehensive_debug.spec.ts:90:47'[39m,
      cause: [90mundefined[39m
    }
  }
}

[1A[2K🔍 Test 5: Workflow creation test

[1A[2K📊 Workflow creation status: [33m404[39m

[1A[2K❌ Workflow creation failed: {"detail":"Not Found"}

[1A[2K🔍 Test 6: Minimal agent creation

[1A[2K📊 Minimal agent creation status: [33m500[39m

[1A[2K❌ Minimal agent creation failed: Internal Server Error

[1A[2K🔍 Test 7: Database introspection

[1A[2K📊 System health error: apiRequestContext.get: read ECONNRESET
Call log:
[2m  - → GET http://localhost:8007/api/system/health[22m
[2m    - user-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.7103.25 Safari/537.36[22m
[2m    - accept: */*[22m
[2m    - accept-encoding: gzip,deflate,br[22m
[2m    - X-Test-Worker: 6[22m

    at [90m/Users/davidrose/git/zerg/e2e/[39mtests/comprehensive_debug.spec.ts:166:48 {
  name: [32m'Error'[39m,
  [[32mSymbol(step)[39m]: {
    stepId: [32m'pw:api@15'[39m,
    location: {
      file: [32m'/Users/davidrose/git/zerg/e2e/tests/comprehensive_debug.spec.ts'[39m,
      line: [33m166[39m,
      column: [33m48[39m
    },
    category: [32m'pw:api'[39m,
    title: [32m'apiRequestContext.get(http://localhost:8007/api/system/health)'[39m,
    apiName: [32m'apiRequestContext.get'[39m,
    params: {
      url: [32m'http://localhost:8007/api/system/health'[39m,
      params: [90mundefined[39m,
      encodedParams: [90mundefined[39m,
      method: [32m'GET'[39m,
      headers: [90mundefined[39m,
      postData: [90mundefined[39m,
      jsonData: [90mundefined[39m,
      formData: [90mundefined[39m,
      multipartData: [90mundefined[39m,
      timeout: [90mundefined[39m,
      failOnStatusCode: [90mundefined[39m,
      ignoreHTTPSErrors: [90mundefined[39m,
      maxRedirects: [90mundefined[39m,
      maxRetries: [90mundefined[39m,
      __testHookLookup: [90mundefined[39m
    },
    boxedStack: [90mundefined[39m,
    steps: [],
    attachmentIndices: [],
    info: TestStepInfoImpl {
      annotations: [],
      _testInfo: [36m[TestInfoImpl][39m,
      _stepId: [32m'pw:api@15'[39m
    },
    complete: [36m[Function: complete][39m,
    endWallTime: [33m1754920000013[39m,
    error: {
      message: [32m'Error: apiRequestContext.get: read ECONNRESET\n'[39m +
        [32m'Call log:\n'[39m +
        [32m'\x1B[2m  - → GET http://localhost:8007/api/system/health\x1B[22m\n'[39m +
        [32m'\x1B[2m    - user-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.7103.25 Safari/537.36\x1B[22m\n'[39m +
        [32m'\x1B[2m    - accept: */*\x1B[22m\n'[39m +
        [32m'\x1B[2m    - accept-encoding: gzip,deflate,br\x1B[22m\n'[39m +
        [32m'\x1B[2m    - X-Test-Worker: 6\x1B[22m\n'[39m,
      stack: [32m'Error: apiRequestContext.get: read ECONNRESET\n'[39m +
        [32m'Call log:\n'[39m +
        [32m'\x1B[2m  - → GET http://localhost:8007/api/system/health\x1B[22m\n'[39m +
        [32m'\x1B[2m    - user-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.7103.25 Safari/537.36\x1B[22m\n'[39m +
        [32m'\x1B[2m    - accept: */*\x1B[22m\n'[39m +
        [32m'\x1B[2m    - accept-encoding: gzip,deflate,br\x1B[22m\n'[39m +
        [32m'\x1B[2m    - X-Test-Worker: 6\x1B[22m\n'[39m +
        [32m'\n'[39m +
        [32m'    at /Users/davidrose/git/zerg/e2e/tests/comprehensive_debug.spec.ts:166:48'[39m,
      cause: [90mundefined[39m
    }
  }
}

[1A[2K✅ Comprehensive debug test complete

[1A[2K[backend-server] Stopping backend for worker 6

[1A[2K  3) [chromium] › tests/agent_creation_full.spec.ts:15:7 › Agent Creation Full Workflow › Complete agent creation and isolation test 

    Error: [2mexpect([22m[31mreceived[39m[2m).[22mtoBe[2m([22m[32mexpected[39m[2m) // Object.is equality[22m

    Expected: [32m201[39m
    Received: [31m500[39m

      56 |       console.log('📊 Agent creation error:', errorBody);
      57 |     }
    > 58 |     expect(createResponse.status()).toBe(201);
         |                                     ^
      59 |     
      60 |     const createdAgent = await createResponse.json();
      61 |     console.log('📊 Created agent ID:', createdAgent.id);
        at /Users/davidrose/git/zerg/e2e/tests/agent_creation_full.spec.ts:58:37

    attachment #1: screenshot (image/png) ──────────────────────────────────────────────────────────
    test-results/agent_creation_full-Agent--c7b1d-creation-and-isolation-test-chromium/test-failed-1.png
    ────────────────────────────────────────────────────────────────────────────────────────────────

    Error Context: test-results/agent_creation_full-Agent--c7b1d-creation-and-isolation-test-chromium/error-context.md

    attachment #3: trace (application/zip) ─────────────────────────────────────────────────────────
    test-results/agent_creation_full-Agent--c7b1d-creation-and-isolation-test-chromium/trace.zip
    Usage:

        npx playwright show-trace test-results/agent_creation_full-Agent--c7b1d-creation-and-isolation-test-chromium/trace.zip

    ────────────────────────────────────────────────────────────────────────────────────────────────

    Retry #1 ───────────────────────────────────────────────────────────────────────────────────────

    Error: apiRequestContext.get: connect ECONNREFUSED ::1:8005
    Call log:
    [2m  - → GET http://localhost:8005/api/agents[22m
    [2m    - user-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.7103.25 Safari/537.36[22m
    [2m    - accept: */*[22m
    [2m    - accept-encoding: gzip,deflate,br[22m
    [2m    - X-Test-Worker: 4[22m

        at apiRequestContext.get: connect ECONNREFUSED ::1:8005
        at /Users/davidrose/git/zerg/e2e/tests/agent_creation_full.spec.ts:36:41

    Error: ENOENT: no such file or directory, open 'apiRequestContext.get: connect ECONNREFUSED :'

    attachment #1: screenshot (image/png) ──────────────────────────────────────────────────────────
    test-results/agent_creation_full-Agent--c7b1d-creation-and-isolation-test-chromium-retry1/test-failed-1.png
    ────────────────────────────────────────────────────────────────────────────────────────────────

    attachment #2: trace (application/zip) ─────────────────────────────────────────────────────────
    test-results/agent_creation_full-Agent--c7b1d-creation-and-isolation-test-chromium-retry1/trace.zip
    Usage:

        npx playwright show-trace test-results/agent_creation_full-Agent--c7b1d-creation-and-isolation-test-chromium-retry1/trace.zip

    ────────────────────────────────────────────────────────────────────────────────────────────────


🧹 Starting test environment cleanup...
✅ Test database cleanup completed
✅ Test environment cleanup completed
[1A[2K  3 failed
    [chromium] › tests/agent_creation_full.spec.ts:15:7 › Agent Creation Full Workflow › Complete agent creation and isolation test 
    [chromium] › tests/canvas_api_contract.spec.ts:42:7 › Canvas API Contract Tests › Wrong canvas-data endpoint returns 404 
    [chromium] › tests/canvas_complete_workflow.spec.ts:17:7 › Complete Canvas Workflow › End-to-end canvas workflow with agent and tool execution 
  3 passed (10.1s)
